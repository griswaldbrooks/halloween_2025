<!DOCTYPE html>
<html>
<head>
    <title>Spider Leg Editor - Interactive</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #f0f0f0;
            font-family: monospace;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        canvas {
            border: 2px solid #333;
            background: white;
            cursor: crosshair;
            display: block;
            margin: 20px auto;
        }
        .controls {
            background: white;
            padding: 15px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }
        .info {
            background: #e8f4f8;
            padding: 10px;
            border: 1px solid #b3d9e6;
            margin-bottom: 10px;
        }
        button {
            padding: 8px 15px;
            margin: 5px;
            cursor: pointer;
        }
        .selected {
            background: #4CAF50;
            color: white;
        }
        #output {
            background: #2b2b2b;
            color: #0f0;
            padding: 10px;
            font-size: 11px;
            overflow-x: auto;
            white-space: pre;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üï∑Ô∏è Spider Leg Editor</h1>

        <div class="info">
            <strong>Instructions:</strong>
            <ul>
                <li><strong>Click and drag</strong> any foot (red circles) to move it</li>
                <li><strong>Click leg number</strong> buttons to select/deselect</li>
                <li>IK automatically adjusts knee position</li>
                <li>Green = selected leg, Blue = dragging</li>
            </ul>
        </div>

        <div class="controls">
            <strong>Select Leg:</strong>
            <button id="leg0" onclick="selectLeg(0)">L0</button>
            <button id="leg1" onclick="selectLeg(1)">L1</button>
            <button id="leg2" onclick="selectLeg(2)">L2</button>
            <button id="leg3" onclick="selectLeg(3)">L3</button>
            <button id="leg4" onclick="selectLeg(4)">L4</button>
            <button id="leg5" onclick="selectLeg(5)">L5</button>
            <button id="leg6" onclick="selectLeg(6)">L6</button>
            <button id="leg7" onclick="selectLeg(7)">L7</button>
            <button onclick="selectLeg(null)">Clear Selection</button>
            <br>
            <button onclick="resetSpider()">Reset to Default</button>
            <button onclick="exportConfig()">Export Config</button>
        </div>

        <canvas id="canvas" width="800" height="800"></canvas>

        <div class="controls">
            <strong>Selected Leg Info:</strong>
            <div id="legInfo">No leg selected</div>
            <div id="legControls" style="margin-top: 10px; display: none;">
                <label>
                    <input type="checkbox" id="flipKnee" onchange="toggleKnee()">
                    Flip IK Solution (changes coxa/shoulder angle to reach same foot position)
                </label>
            </div>
        </div>

        <div class="controls">
            <strong>Export Configuration (JSON):</strong>
            <pre id="output">Click "Export Config" to see JSON configuration...</pre>
        </div>
    </div>

    <script src="leg-kinematics.js"></script>
    <script src="spider-model.js"></script>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let spider = null;
        let selectedLeg = null;
        let draggingLeg = null;
        let dragOffset = { x: 0, y: 0 };

        class EditableSpider {
            constructor(x, y, size) {
                this.x = x;
                this.y = y;
                this.bodySize = size;
                this.body = new SpiderBody(this.bodySize);
                this.color = '#000000';

                // Create legs with customizable elbow bias
                // User's custom configuration from spider-config.json
                const customElbowBias = [-1, 1, -1, 1, 1, -1, 1, -1];

                this.legs = [];
                this.legElbowBias = []; // Track elbow bias per leg
                for (let i = 0; i < 8; i++) {
                    const attachment = this.body.getAttachment(i);
                    const elbowBias = customElbowBias[i];

                    const leg = new Leg2D({
                        attachX: attachment.x,
                        attachY: attachment.y,
                        upperLength: this.body.legUpperLength,
                        lowerLength: this.body.legLowerLength,
                        side: attachment.side,
                        baseAngle: attachment.baseAngle,
                        elbowBias: elbowBias
                    });

                    leg.index = i;
                    this.legs.push(leg);
                    this.legElbowBias[i] = elbowBias;
                }

                this.initializeLegPositions();
            }

            initializeLegPositions() {
                // Load user's custom foot positions from config
                const customFootPositions = [
                    { x: 560.2, y: 500.2 },  // Leg 0
                    { x: 560.2, y: 299.8 },  // Leg 1
                    { x: 515.2, y: 530.4 },  // Leg 2
                    { x: 515.2, y: 269.6 },  // Leg 3
                    { x: 339.8, y: 530.4 },  // Leg 4
                    { x: 339.8, y: 269.6 },  // Leg 5
                    { x: 299.8, y: 500.2 },  // Leg 6
                    { x: 299.8, y: 299.8 }   // Leg 7
                ];

                for (const leg of this.legs) {
                    const pos = customFootPositions[leg.index];
                    leg.worldFootX = pos.x;
                    leg.worldFootY = pos.y;
                }
            }

            setFootPosition(legIndex, worldX, worldY) {
                const leg = this.legs[legIndex];
                leg.worldFootX = worldX;
                leg.worldFootY = worldY;
            }

            getFootPosition(legIndex) {
                const leg = this.legs[legIndex];
                return { x: leg.worldFootX, y: leg.worldFootY };
            }

            setElbowBias(legIndex, bias) {
                this.legs[legIndex].elbowBias = bias;
                this.legElbowBias[legIndex] = bias;
            }

            getElbowBias(legIndex) {
                return this.legElbowBias[legIndex];
            }

            draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                ctx.save();
                ctx.translate(this.x, this.y);

                // Draw legs
                for (let i = 0; i < this.legs.length; i++) {
                    const leg = this.legs[i];
                    const isSelected = selectedLeg === i;
                    const isDragging = draggingLeg === i;

                    this.drawLeg(leg, isSelected, isDragging);
                }

                // Draw body
                ctx.strokeStyle = '#000';
                ctx.fillStyle = '#000';
                ctx.lineWidth = this.bodySize * 0.1;

                // Cephalothorax
                ctx.beginPath();
                ctx.ellipse(
                    this.body.cephalothorax.center, 0,
                    this.body.cephalothorax.length / 2,
                    this.body.cephalothorax.width / 2,
                    0, 0, Math.PI * 2
                );
                ctx.fill();

                // Abdomen
                ctx.beginPath();
                ctx.ellipse(
                    this.body.abdomen.center, 0,
                    this.body.abdomen.length / 2,
                    this.body.abdomen.width / 2,
                    0, 0, Math.PI * 2
                );
                ctx.fill();

                ctx.restore();

                // Draw annotations
                this.drawAnnotations();
            }

            drawLeg(leg, isSelected, isDragging) {
                const targetX = leg.worldFootX - this.x;
                const targetY = leg.worldFootY - this.y;

                leg.setFootPosition(targetX, targetY);
                const positions = leg.forwardKinematics();

                // Color based on state
                let color = '#000';
                if (isDragging) color = '#0066FF';
                else if (isSelected) color = '#00AA00';

                ctx.strokeStyle = color;
                ctx.lineWidth = isSelected ? 3 : 2;

                // Upper segment (coxa/shoulder to femur/knee)
                ctx.beginPath();
                ctx.moveTo(leg.attachX, leg.attachY);
                ctx.lineTo(positions.knee.x, positions.knee.y);
                ctx.stroke();

                // Lower segment (femur/knee to foot)
                ctx.beginPath();
                ctx.moveTo(positions.knee.x, positions.knee.y);
                ctx.lineTo(positions.foot.x, positions.foot.y);
                ctx.stroke();

                // Draw joint circles
                // Attachment point (coxa - shoulder)
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(leg.attachX, leg.attachY, 4, 0, Math.PI * 2);
                ctx.fill();

                // Femur/Knee joint
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(positions.knee.x, positions.knee.y, 5, 0, Math.PI * 2);
                ctx.fill();

                // Foot (larger, clickable)
                ctx.fillStyle = isDragging ? '#0066FF' : '#FF0000';
                ctx.beginPath();
                ctx.arc(positions.foot.x, positions.foot.y, 6, 0, Math.PI * 2);
                ctx.fill();

                // Draw joint labels if selected
                if (isSelected) {
                    ctx.save();
                    ctx.font = 'bold 11px monospace';
                    ctx.fillStyle = '#00AA00';
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 3;

                    // Attachment label with coordinates
                    const attachWorldX = this.x + leg.attachX;
                    const attachWorldY = this.y + leg.attachY;
                    const attachText = `Attachment (${attachWorldX.toFixed(0)}, ${attachWorldY.toFixed(0)})`;
                    ctx.strokeText(attachText, leg.attachX + 8, leg.attachY - 8);
                    ctx.fillText(attachText, leg.attachX + 8, leg.attachY - 8);

                    // Knee/Femur label with coordinates
                    const kneeWorldX = this.x + positions.knee.x;
                    const kneeWorldY = this.y + positions.knee.y;
                    const kneeText = `Femur/Knee (${kneeWorldX.toFixed(0)}, ${kneeWorldY.toFixed(0)})`;
                    ctx.strokeText(kneeText, positions.knee.x + 8, positions.knee.y - 8);
                    ctx.fillText(kneeText, positions.knee.x + 8, positions.knee.y - 8);

                    // Foot label with ACTUAL rendered coordinates (from FK)
                    const footWorldX = this.x + positions.foot.x;
                    const footWorldY = this.y + positions.foot.y;
                    const footText = `Foot (${footWorldX.toFixed(0)}, ${footWorldY.toFixed(0)})`;
                    ctx.strokeText(footText, positions.foot.x + 8, positions.foot.y + 15);
                    ctx.fillText(footText, positions.foot.x + 8, positions.foot.y + 15);

                    ctx.restore();
                }
            }

            drawAnnotations() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.font = '11px monospace';

                for (let i = 0; i < this.legs.length; i++) {
                    const leg = this.legs[i];
                    const attachment = this.body.getAttachment(i);

                    const targetX = leg.worldFootX - this.x;
                    const targetY = leg.worldFootY - this.y;
                    leg.setFootPosition(targetX, targetY);
                    const positions = leg.forwardKinematics();

                    const isSelected = selectedLeg === i;
                    ctx.fillStyle = isSelected ? '#00AA00' : '#666';

                    // Leg number near foot
                    const angle = Math.atan2(positions.foot.y, positions.foot.x);
                    const offset = 15;
                    const textX = positions.foot.x + Math.cos(angle) * offset;
                    const textY = positions.foot.y + Math.sin(angle) * offset;

                    ctx.font = isSelected ? 'bold 14px monospace' : '11px monospace';
                    ctx.fillText(`L${i}`, textX, textY);
                }

                ctx.restore();
            }

            getLegAtPosition(worldX, worldY) {
                const localX = worldX - this.x;
                const localY = worldY - this.y;

                for (let i = 0; i < this.legs.length; i++) {
                    const leg = this.legs[i];
                    const targetX = leg.worldFootX - this.x;
                    const targetY = leg.worldFootY - this.y;

                    leg.setFootPosition(targetX, targetY);
                    const positions = leg.forwardKinematics();

                    const dx = positions.foot.x - localX;
                    const dy = positions.foot.y - localY;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < 10) return i;
                }
                return null;
            }
        }

        function resetSpider() {
            spider = new EditableSpider(400, 400, 100);
            selectedLeg = null;
            updateLegInfo();
            spider.draw();
        }

        function selectLeg(index) {
            selectedLeg = index;
            updateButtons();
            updateLegInfo();
            spider.draw();
        }

        function updateButtons() {
            for (let i = 0; i < 8; i++) {
                const btn = document.getElementById(`leg${i}`);
                btn.className = selectedLeg === i ? 'selected' : '';
            }
        }

        function updateLegInfo() {
            const info = document.getElementById('legInfo');
            const controls = document.getElementById('legControls');

            if (selectedLeg === null) {
                info.innerHTML = 'No leg selected';
                controls.style.display = 'none';
                return;
            }

            const leg = spider.legs[selectedLeg];
            const attachment = spider.body.getAttachment(selectedLeg);
            const targetX = leg.worldFootX - spider.x;
            const targetY = leg.worldFootY - spider.y;
            leg.setFootPosition(targetX, targetY);
            const positions = leg.forwardKinematics();

            const angleDeg = (attachment.baseAngle * 180 / Math.PI).toFixed(1);
            const elbowBias = spider.getElbowBias(selectedLeg);
            const coxaAngleDeg = (leg.coxaAngle * 180 / Math.PI).toFixed(1);
            const femurAngleDeg = (leg.femurAngle * 180 / Math.PI).toFixed(1);

            // Get actual rendered positions from FK
            const actualFootX = spider.x + positions.foot.x;
            const actualFootY = spider.y + positions.foot.y;

            info.innerHTML = `
                <strong>Leg ${selectedLeg}</strong><br>
                Base Angle: ${angleDeg}¬∞<br>
                <strong>Joint Angles:</strong><br>
                ‚Ä¢ Coxa/Shoulder: ${coxaAngleDeg}¬∞ (changes with flip)<br>
                ‚Ä¢ Femur/Knee: ${femurAngleDeg}¬∞ (relative to upper segment)<br>
                <strong>Actual Rendered Positions (from FK):</strong><br>
                ‚Ä¢ Attachment: (${(spider.x + leg.attachX).toFixed(1)}, ${(spider.y + leg.attachY).toFixed(1)})<br>
                ‚Ä¢ Knee: (${(spider.x + positions.knee.x).toFixed(1)}, ${(spider.y + positions.knee.y).toFixed(1)})<br>
                ‚Ä¢ Foot: (${actualFootX.toFixed(1)}, ${actualFootY.toFixed(1)})<br>
                <strong>Target Foot Position (stored):</strong><br>
                ‚Ä¢ (${leg.worldFootX.toFixed(1)}, ${leg.worldFootY.toFixed(1)})<br>
                IK Solution (elbow bias): ${elbowBias}
            `;

            // Show flip knee control
            controls.style.display = 'block';
            document.getElementById('flipKnee').checked = (elbowBias === -1);
        }

        function toggleKnee() {
            if (selectedLeg === null) return;

            const currentBias = spider.getElbowBias(selectedLeg);
            const newBias = currentBias === 1 ? -1 : 1;
            spider.setElbowBias(selectedLeg, newBias);

            updateLegInfo();
            spider.draw();
        }

        function exportConfig() {
            const output = document.getElementById('output');

            const config = {
                spider: {
                    center: { x: spider.x, y: spider.y },
                    bodySize: spider.bodySize
                },
                legs: []
            };

            for (let i = 0; i < spider.legs.length; i++) {
                const leg = spider.legs[i];
                const attachment = spider.body.getAttachment(i);
                const targetX = leg.worldFootX - spider.x;
                const targetY = leg.worldFootY - spider.y;
                leg.setFootPosition(targetX, targetY);
                const positions = leg.forwardKinematics();

                config.legs.push({
                    index: i,
                    baseAngle: attachment.baseAngle,
                    baseAngleDeg: parseFloat((attachment.baseAngle * 180 / Math.PI).toFixed(1)),
                    elbowBias: spider.getElbowBias(i),
                    foot: {
                        x: parseFloat(leg.worldFootX.toFixed(1)),
                        y: parseFloat(leg.worldFootY.toFixed(1))
                    },
                    knee: {
                        x: parseFloat((spider.x + positions.knee.x).toFixed(1)),
                        y: parseFloat((spider.y + positions.knee.y).toFixed(1))
                    }
                });
            }

            output.textContent = JSON.stringify(config, null, 2);
        }

        // Mouse handling
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const legIndex = spider.getLegAtPosition(x, y);
            if (legIndex !== null) {
                draggingLeg = legIndex;
                selectedLeg = legIndex;
                const foot = spider.getFootPosition(legIndex);
                dragOffset.x = foot.x - x;
                dragOffset.y = foot.y - y;
                updateButtons();
                updateLegInfo();
                spider.draw();
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            if (draggingLeg === null) return;

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            spider.setFootPosition(draggingLeg, x + dragOffset.x, y + dragOffset.y);
            updateLegInfo();
            spider.draw();
        });

        canvas.addEventListener('mouseup', () => {
            draggingLeg = null;
            spider.draw();
        });

        canvas.addEventListener('mouseleave', () => {
            draggingLeg = null;
            spider.draw();
        });

        // Initialize
        resetSpider();
        console.log('Spider Editor Ready!');
        console.log('Click and drag red circles to move leg feet');
    </script>
</body>
</html>
